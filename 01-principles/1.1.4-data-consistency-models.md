# 1.1.4 Data Consistency Models: Strong vs. Eventual

## Intuitive Explanation

Imagine you and a friend are editing a shared document online (like Google Docs) where changes are saved simultaneously
on multiple servers (nodes).

1. **Strong Consistency (The immediate update):** When you type "Hello," your friend sees "Hello" immediately, no matter
   which server they are connected to. All copies of the data are identical after every successful write.
2. **Eventual Consistency (The delayed sync):** When you type "Hello," your friend might briefly see the old text ("Hi")
   because the change hasn't propagated to their server yet. The system guarantees that eventually, all copies will
   match, but there's a window of delay.

The choice of consistency model dictates the user experience and the system's scalability (often trading one for the
other).

---

## In-Depth Analysis

Consistency models define the rules for visibility and ordering of updates in a distributed system. This is a critical
factor in the **CAP Theorem** (where Consistency is 'C').

### 1. Strong Consistency (Linearizability)

- **Definition:** A system is strongly consistent if, after a write operation completes, any subsequent read operation
  returns the result of that write. It is as if all operations executed atomically on a single server.
- **Mechanism:** Requires immediate, synchronous communication and agreement among all participating nodes before a
  write is acknowledged. This often involves consensus protocols like Paxos or Raft.
- **Pro:** Simplest for developers; guarantees data integrity (crucial for financial ledgers).
- **Con:** Slows down the system (high latency) because nodes must wait for remote acknowledgments, severely limiting
  horizontal write scaling.

### 2. Eventual Consistency

- **Definition:** The system will eventually become consistent, meaning that if no new updates are made, all reads will
  eventually return the last written value. The system accepts a period of "inconsistency" to maintain high availability
  and low latency.
- **Mechanism:** Asynchronous data replication (e.g., background replication from a primary to secondary nodes).
- **Pro:** Extremely high availability (AP systems) and low latency for writes, enabling massive horizontal scale.
- **Con:** Developers must handle read-after-write issues (a user might read their own just-submitted data from a stale
  replica).

### Intermediate Consistency Models

Since pure strong or pure eventual consistency often forces severe trade-offs, real-world systems use models that fall
between the two extremes:

- **Read-Your-Writes Consistency:** Guarantees that if a user updates an item, they will never see a stale version of
  that item again, though other users might.

- **Session Consistency:** An extension of Read-Your-Writes, guaranteeing that all writes performed within a user's
  session are visible to that user in subsequent reads.

- **Monotonic Reads:** Guarantees that if a process reads a value X, subsequent reads by that same process will never
  return an older version of X.

---

## üí° Real-World Use Cases

- **Database Master-Replica:** When a write hits the Master database and is replicated asynchronously to the Read
  Replicas, the replicas exhibit Eventual Consistency.
- **E-commerce Cart (Session Consistency):** When you add an item to your cart, the system ensures that your cart view
  is always consistent, even if the inventory count shown to another user is slightly delayed.
- **Distributed File Storage (Eventual Consistency):** Services like AWS S3 or Google Cloud Storage prioritize
  availability for massive file storage, often relying on eventual consistency for metadata updates.

---

## ‚úèÔ∏è Design Challenge

### Problem

You are designing a service that manages user profiles and displays their current "reputation score." A user's
reputation score is updated asynchronously after they complete a task.

1. Which consistency model is acceptable for displaying the score to other users?
2. Which consistency model is mandatory for displaying the score to the user who just completed the task (the writer)?

### Solution

#### Scenario Overview

- Users have a reputation score stored in some database.
- The score updates asynchronously after a user completes a task.
- The system must display this score to:
    - Other users (readers)
    - The same user who just completed the task (writer)

#### 1Ô∏è‚É£ For Other Users

- Acceptable Consistency Model: ‚úÖ Eventual Consistency
- Reasoning:
    - Other users viewing someone‚Äôs reputation do not require immediate accuracy.
    - It's fine if they see a slightly stale value, since updates can propagate asynchronously.
    - Prioritizing availability and scalability over strict consistency is acceptable here.

#### 2Ô∏è‚É£ For the Same User (the Writer)

Required Consistency Model: üîí Read-Your-Writes Consistency (or Monotonic Reads)

Reasoning:

- The user who just completed the task expects to see their updated score immediately.
- Even though the update is asynchronous, the system must ensure that once the update is acknowledged, their next read
  reflects it.
- Seeing an outdated score after completing a task would break user trust and create confusion.

#### ‚úÖ Summary Answer

| Viewer Type            | Acceptable Consistency Model     | Rationale                                                                |
|------------------------|----------------------------------|--------------------------------------------------------------------------|
| Other users            | **Eventual consistency**         | Slight staleness is acceptable; prioritizes availability and performance |
| The same user (writer) | **Read-your-writes consistency** | Must see their own latest updates for correctness and good UX            |
