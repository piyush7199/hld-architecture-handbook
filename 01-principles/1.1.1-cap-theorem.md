# 1.1.1 CAP Theorem: Consistency, Availability, and Partition Tolerance

## Intuitive Explanation

Imagine you are managing a chain of coffee shops (a distributed system). Each shop has a board listing the price of a
Latte.

The **CAP Theorem** states that if the connection between the shops breaks (a Partition), you must choose which of the
remaining two properties to uphold:

1. **Consistency (C):** Do all shops show the exact same price, even if it means some shops can't take orders because
   they can't confirm the price?
2. **Availability (A):** Can every shop always take an order, even if the price they show might be slightly outdated
   compared to other shops?

You can only guarantee two out of three: _Consistency_, _Availability_, or _Partition Tolerance_. Since network
partitions are inevitable in large systems, the choice is usually between `C` and `A`.

---

## In-Depth Analysis

The CAP theorem applies to systems that store state (data) across multiple nodes.

- **Consistency (C):** Every read receives the most recent write or an error. In a consistent system, once data is
  written to one node, all subsequent reads from any node must return that new data. This is often achieved via strong
  consensus mechanisms.
- **Availability (A):** Every request receives a response (not necessarily the most recent data), without guarantee that
  it is the most recent. The system must remain operational and responsive 100% of the time.
- **Partition Tolerance (P):** The system continues to operate despite arbitrary message loss or failure of parts of the
  system (network partitions). Since distributed systems rely on networks, P is mandatory for large-scale designs.

In reality, most systems choose **AP** (Availability over Strong Consistency) or **CP** (Consistency over Availability)
during a network failure.

---

## Key Concepts / Tradeoffs

- **CP Systems (Consistency + Partition Tolerance):** If a partition occurs, the nodes on the "minority" side of the
  partition will deliberately go offline or reject writes until the partition is resolved and data can be synced.
    - Example: Databases like traditional RDBMS (PostgreSQL, MySQL) often prioritize C.

- **AP Systems (Availability + Partition Tolerance):** If a partition occurs, all nodes remain active and accept reads
  and writes. Data conflicts will be resolved later once the partition heals, leading to Eventual Consistency.
    - Example: Highly available NoSQL databases (Cassandra, Couchbase) prioritize A.

- **Partition Scope: P** in the CAP theorem means network failure, not just dividing the database (sharding).

---

## üí° Real-World Use Cases

- **Banking Transactions (CP):** Financial ledger systems must be **CP**. If a link breaks, the system will reject a
  transaction rather than risk showing a customer a wrong balance or double-spending money.
- **Social Media Feeds (AP):** Showing a user a slightly older version of their friend's feed (stale data) is acceptable
  if it means the user can still access the platform. **Availability** is prioritized over strong consistency.
- **DNS (AP):** Domain Name Servers (DNS) prioritize availability so you can always access a website. Updates to DNS
  records can take up to 48 hours to propagate globally (a clear example of eventual consistency).

---

## ‚úèÔ∏è Design Challenge

You are designing a user profile service. User profiles are read far more often than they are written. If a network
partition occurs between your two main data centers, would you choose an AP or a CP model for your service, and why?