# 1.1.1 CAP Theorem: Consistency, Availability, and Partition Tolerance

## Intuitive Explanation

Imagine you are managing a chain of coffee shops (a distributed system). Each shop has a board listing the price of a
Latte.

The **CAP Theorem** states that if the connection between the shops breaks (a Partition), you must choose which of the
remaining two properties to uphold:

1. **Consistency (C):** Do all shops show the exact same price, even if it means some shops can't take orders because
   they can't confirm the price?
2. **Availability (A):** Can every shop always take an order, even if the price they show might be slightly outdated
   compared to other shops?

You can only guarantee two out of three: _Consistency_, _Availability_, or _Partition Tolerance_. Since network
partitions are inevitable in large systems, the choice is usually between `C` and `A`.

---

## In-Depth Analysis

The CAP theorem applies to systems that store state (data) across multiple nodes.

- **Consistency (C):** Every read receives the most recent write or an error. In a consistent system, once data is
  written to one node, all subsequent reads from any node must return that new data. This is often achieved via strong
  consensus mechanisms.
- **Availability (A):** Every request receives a response (not necessarily the most recent data), without guarantee that
  it is the most recent. The system must remain operational and responsive 100% of the time.
- **Partition Tolerance (P):** The system continues to operate despite arbitrary message loss or failure of parts of the
  system (network partitions). Since distributed systems rely on networks, P is mandatory for large-scale designs.

In reality, most systems choose **AP** (Availability over Strong Consistency) or **CP** (Consistency over Availability)
during a network failure.

---

## Key Concepts / Tradeoffs

- **CP Systems (Consistency + Partition Tolerance):** If a partition occurs, the nodes on the "minority" side of the
  partition will deliberately go offline or reject writes until the partition is resolved and data can be synced.
    - Example: Databases like traditional RDBMS (PostgreSQL, MySQL) often prioritize C.

- **AP Systems (Availability + Partition Tolerance):** If a partition occurs, all nodes remain active and accept reads
  and writes. Data conflicts will be resolved later once the partition heals, leading to Eventual Consistency.
    - Example: Highly available NoSQL databases (Cassandra, Couchbase) prioritize A.

- **Partition Scope: P** in the CAP theorem means network failure, not just dividing the database (sharding).

---

## ðŸ’¡ Real-World Use Cases

- **Banking Transactions (CP):** Financial ledger systems must be **CP**. If a link breaks, the system will reject a
  transaction rather than risk showing a customer a wrong balance or double-spending money.
- **Social Media Feeds (AP):** Showing a user a slightly older version of their friend's feed (stale data) is acceptable
  if it means the user can still access the platform. **Availability** is prioritized over strong consistency.
- **DNS (AP):** Domain Name Servers (DNS) prioritize availability so you can always access a website. Updates to DNS
  records can take up to 48 hours to propagate globally (a clear example of eventual consistency).

---

## âœï¸ Design Challenge

### Problem

You are designing a user profile service. User profiles are read far more often than they are written. If a network
partition occurs between your two main data centers, would you choose an AP or a CP model for your service, and why?

### Solution

#### âš–ï¸ Scenario

- Youâ€™re designing a User Profile Service.
- Reads â‰« Writes (profiles are mostly read, rarely updated).
- There are two main data centers.
- Occasionally, a network partition can occur between them.

We must choose between:

- AP (Availability + Partition Tolerance)
- CP (Consistency + Partition Tolerance)

#### ðŸ§© Step 1 â€” Understand what happens during a partition

When a partition occurs, the two data centers cannot communicate.
So:

- **AP system:** Both data centers stay online and serve requests (possibly stale data).

- **CP system:** One data center (or both) may refuse requests to preserve strict consistency.

#### ðŸ§© Step 2 â€” Evaluate based on business needs

**User Profile characteristics**

- Reads dominate (profiles are displayed constantly).
- Writes (profile updates) are infrequent.
- Slightly stale data is tolerable (e.g., user updates bio â†’ others can see it a few seconds/minutes later).
- However, total unavailability (â€œCanâ€™t load profileâ€) would be unacceptable for user experience.

Hence:

- The system should continue serving reads even if the data centers canâ€™t talk.
- Minor inconsistency (eventual consistency) is acceptable.
- Availability > Strong Consistency during partitions.

#### âœ… Answer

**ðŸ‘‰ Choose an AP (Available + Partition-tolerant) model.**

**Reasoning:**

- During a partition, users in each data center should still be able to:
- Read profiles locally (possibly slightly outdated).
- Maybe even update their own profile (with eventual sync).
- Temporary staleness is acceptable because correctness is not critical.
- Downtime (loss of availability) would degrade user experience far more than a stale profile.

#### âœ… Final Summary

| Aspect                          | Choice                                                                                 | Reason                                                       |
|---------------------------------|----------------------------------------------------------------------------------------|--------------------------------------------------------------|
| **Consistency vs Availability** | **Prefer Availability (AP)**                                                           | User experience benefits from always-on reads, even if stale |
| **Tolerance**                   | **Partition Tolerant**                                                                 | Network partitions between DCs are expected                  |
| **Justification**               | Reads >> Writes, so eventual consistency is acceptable; availability is more important |                                                              |
