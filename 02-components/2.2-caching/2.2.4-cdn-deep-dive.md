# 2.2.4 CDN Deep Dive: Global Content Delivery for Scale and Performance

## Intuitive Explanation

Imagine you're running a global news website. A user in Tokyo wants to read an article, but your servers are in New
York. Without a CDN, the article (images, videos, text) must travel 6,700 miles across the Pacific Ocean, causing slow
load times.

**CDN (Content Delivery Network)** is like having local libraries in every city. Instead of one central library in New
York, you have copies of popular books in libraries worldwide. When someone in Tokyo wants a book, they get it from the
Tokyo library (milliseconds away) instead of waiting for it to ship from New York.

**In distributed systems:**

- **CDN:** A network of geographically distributed servers (edge locations) that cache and serve content close to users
- **Goal:** Reduce latency and bandwidth costs by serving content from the nearest location
- **Benefit:** 10-100Ã— faster content delivery and 90%+ reduction in origin server bandwidth

---

## In-Depth Analysis

### 1. What is a CDN?

A **Content Delivery Network (CDN)** is a geographically distributed network of proxy servers and data centers that
cache and serve content (images, videos, HTML, CSS, JavaScript) to users from locations closest to them.

**Key Components:**

- **Origin Server:** Your main server (source of truth for content)
- **Edge Servers:** CDN servers located near users (cache content)
- **CDN Network:** Interconnected edge servers across the globe

**Architecture:**

```
User (Tokyo) â†’ CDN Edge (Tokyo) â†’ Serves cached content (fast, <10ms)
User (London) â†’ CDN Edge (London) â†’ Serves cached content (fast, <10ms)
User (New York) â†’ CDN Edge (New York) â†’ Serves cached content (fast, <10ms)

If cache miss:
Edge Server â†’ Origin Server (New York) â†’ Fetches content â†’ Caches â†’ Serves to user
```

### 2. How CDN Works

#### Step 1: First Request (Cache Miss)

```
1. User requests: https://cdn.example.com/image.jpg
2. DNS resolves to nearest CDN edge server (Tokyo)
3. Edge server checks cache â†’ Not found (cache miss)
4. Edge server requests from origin server (New York)
5. Origin server responds with image
6. Edge server caches image
7. Edge server serves image to user
```

**Latency:**

- Origin fetch: 200ms (Tokyo â†’ New York)
- Total: ~250ms (first request)

#### Step 2: Subsequent Requests (Cache Hit)

```
1. User requests: https://cdn.example.com/image.jpg
2. DNS resolves to nearest CDN edge server (Tokyo)
3. Edge server checks cache â†’ Found (cache hit)
4. Edge server serves image to user (from cache)
```

**Latency:**

- Cache hit: <10ms (served from local edge)
- Total: ~15ms (subsequent requests)

**Result:** 16Ã— faster (250ms â†’ 15ms)

### 3. CDN Caching Strategies

#### Cache-Control Headers

**Origin Server Sets Headers:**

```
Cache-Control: public, max-age=3600
ETag: "abc123"
Last-Modified: Wed, 21 Oct 2024 07:28:00 GMT
```

**CDN Behavior:**

- **public:** Can be cached by CDN
- **max-age=3600:** Cache for 1 hour
- **ETag:** Used for cache validation
- **Last-Modified:** Used for cache validation

#### Cache Invalidation

**Problem:** Content updated on origin, but CDN still serves old cached version

**Solutions:**

**A. TTL-Based Expiration:**

```
Cache-Control: max-age=3600
â†’ Content expires after 1 hour
â†’ CDN fetches fresh content after expiration
```

**B. Manual Invalidation:**

```
CDN API: Invalidate /images/logo.png
â†’ CDN removes from cache immediately
â†’ Next request fetches from origin
```

**C. Versioned URLs:**

```
Old: /images/logo.png
New: /images/logo-v2.png
â†’ New URL bypasses cache
â†’ Old URL still cached (acceptable)
```

**D. Query String Invalidation:**

```
/images/logo.png?v=2
â†’ Change version number to force cache refresh
```

### 4. CDN Types

#### Push CDN (Origin Push)

**How It Works:**

- You upload content to CDN proactively
- CDN stores content before users request it

**Flow:**

```
1. Upload video to origin server
2. Origin server pushes to CDN
3. CDN distributes to all edge locations
4. Users request â†’ Served from edge (cache hit)
```

**Pros:**

- Guaranteed cache hit (content pre-loaded)
- Predictable performance
- Good for large files (videos, software downloads)

**Cons:**

- Must upload to CDN (extra step)
- Storage cost (pay for storage even if not accessed)
- Slower updates (must re-upload to update)

**Use Cases:**

- Software downloads
- Large video files
- Static websites

#### Pull CDN (On-Demand)

**How It Works:**

- CDN fetches content from origin on first request
- Content cached for subsequent requests

**Flow:**

```
1. User requests content
2. CDN checks cache â†’ Miss
3. CDN fetches from origin
4. CDN caches content
5. CDN serves to user
6. Subsequent requests â†’ Cache hit
```

**Pros:**

- Simple (no upload step)
- Automatic (CDN handles caching)
- Cost-effective (only cache accessed content)

**Cons:**

- First request slower (cache miss)
- Origin server must handle cache misses
- Cache may expire before all users access

**Use Cases:**

- Dynamic content
- Frequently updated content
- Web applications

### 5. CDN Features

#### Geographic Distribution

**Edge Locations:**

- CDNs have 100-200+ edge locations worldwide
- Content served from nearest edge to user

**Example:**

```
User in Tokyo â†’ Edge in Tokyo (10ms latency)
User in London â†’ Edge in London (15ms latency)
User in SÃ£o Paulo â†’ Edge in SÃ£o Paulo (20ms latency)
```

#### DDoS Protection

**How It Works:**

- CDN absorbs DDoS attacks at edge
- Attack traffic doesn't reach origin server
- CDN filters malicious traffic

**Benefits:**

- Origin server protected
- Attack distributed across edge locations
- Automatic mitigation

#### SSL/TLS Termination

**How It Works:**

- CDN handles SSL certificates
- HTTPS traffic encrypted to edge
- Edge-to-origin can be HTTP (private network)

**Benefits:**

- Simplified certificate management
- SSL hardware acceleration at edge
- Offloads CPU from origin

#### Compression

**How It Works:**

- CDN compresses content (Gzip, Brotli)
- Reduces bandwidth usage
- Faster content delivery

**Example:**

```
Original: 1 MB HTML file
Compressed: 200 KB (80% reduction)
â†’ 5Ã— faster download
```

#### Image Optimization

**Features:**

- Automatic image format conversion (WebP, AVIF)
- Image resizing on-the-fly
- Lazy loading

**Example:**

```
Request: /images/photo.jpg?width=800&format=webp
CDN: Resizes to 800px, converts to WebP
Response: Optimized image (50% smaller)
```

### 6. CDN Providers Comparison

| Provider             | Edge Locations | Features                         | Best For                       |
|----------------------|----------------|----------------------------------|--------------------------------|
| **CloudFront (AWS)** | 400+           | Integrated with AWS, Lambda@Edge | AWS-based applications         |
| **Cloudflare**       | 200+           | DDoS protection, WAF, Workers    | Security-focused, global reach |
| **Akamai**           | 4,000+         | Enterprise-grade, video delivery | Large enterprises, media       |
| **Fastly**           | 100+           | Real-time purging, Varnish-based | Dynamic content, real-time     |
| **Google Cloud CDN** | 100+           | Integrated with GCP              | GCP-based applications         |

### 7. CDN Caching Patterns

#### Static Assets

**Content:** Images, CSS, JavaScript, fonts

**Configuration:**

```
Cache-Control: public, max-age=31536000 (1 year)
â†’ Long TTL (content rarely changes)
â†’ High cache hit rate (95%+)
```

#### Dynamic Content

**Content:** HTML pages, API responses

**Configuration:**

```
Cache-Control: public, max-age=60 (1 minute)
â†’ Short TTL (content changes frequently)
â†’ Lower cache hit rate (50-70%)
```

#### Personalized Content

**Content:** User-specific pages

**Configuration:**

```
Cache-Control: private, no-cache
â†’ Not cached (user-specific)
â†’ Always fetched from origin
```

---

## When to Use CDN

### âœ… Use CDN When:

1. **Global Audience:** Users worldwide (latency reduction critical)
2. **Static Assets:** Images, videos, CSS, JavaScript (high cache hit rate)
3. **High Bandwidth:** Large files (videos, software downloads)
4. **Traffic Spikes:** Sudden traffic increases (CDN absorbs load)
5. **Cost Optimization:** Reduce origin server bandwidth costs
6. **Security:** Need DDoS protection

### âŒ Don't Use CDN When:

1. **Local Audience:** All users in same region (minimal benefit)
2. **Highly Dynamic:** Content changes every request (low cache hit rate)
3. **Small Scale:** Low traffic (CDN cost may exceed benefit)
4. **Real-Time Data:** Stock prices, live scores (must be fresh)

---

## Real-World Examples

### Netflix

**CDN Strategy:** Custom CDN (Open Connect)

**Architecture:**

- Netflix deploys servers in ISP data centers
- ISPs host Netflix servers (free bandwidth for ISP)
- Content pre-loaded on servers
- 99%+ cache hit rate

**Scale:**

- 8 trillion hours watched annually
- 15% of global internet traffic
- 1,000+ Open Connect servers worldwide

### YouTube

**CDN Strategy:** Google's Global CDN

**Architecture:**

- Google's global network (200+ edge locations)
- Videos cached at edge
- Adaptive bitrate streaming (multiple quality levels)

**Scale:**

- 500 hours of video uploaded per minute
- Billions of video views per day
- 95%+ cache hit rate

### Cloudflare

**CDN Strategy:** Global Anycast Network

**Features:**

- 200+ edge locations
- DDoS protection (largest in world)
- WAF (Web Application Firewall)
- Workers (edge computing)

**Use Cases:**

- Website acceleration
- DDoS mitigation
- Security (WAF, bot protection)

---

## CDN vs. Other Caching Solutions

| Solution                      | Location            | Best For                        | Latency  |
|-------------------------------|---------------------|---------------------------------|----------|
| **CDN**                       | Edge (near users)   | Static assets, global audience  | <20ms    |
| **Application Cache (Redis)** | Application servers | Dynamic data, database queries  | <1ms     |
| **Browser Cache**             | User's device       | Repeated visits, offline access | 0ms      |
| **Origin Server**             | Data center         | Dynamic content, API responses  | 50-200ms |

---

## Common Anti-Patterns

### âŒ **1. No Cache Headers**

**Problem:** CDN doesn't cache content (always fetches from origin)

**Solution:** Set proper Cache-Control headers

```
âŒ Bad:
Cache-Control: no-cache
â†’ CDN never caches, always fetches from origin

âœ… Good:
Cache-Control: public, max-age=3600
â†’ CDN caches for 1 hour, high cache hit rate
```

### âŒ **2. Too Long TTL**

**Problem:** Content updated but CDN serves stale version for days

**Solution:** Use appropriate TTL based on update frequency

```
âŒ Bad:
Static logo: max-age=31536000 (1 year)
â†’ Logo updated but users see old version for year

âœ… Good:
Static logo: max-age=86400 (1 day)
â†’ Logo updates within 1 day
```

### âŒ **3. No Cache Invalidation**

**Problem:** Critical content updated but CDN serves old version

**Solution:** Implement cache invalidation strategy

```
âŒ Bad:
Security patch deployed â†’ CDN serves old vulnerable version

âœ… Good:
Deploy patch â†’ Invalidate CDN cache â†’ Users get new version
```

### âŒ **4. Caching Personalized Content**

**Problem:** User-specific content cached and served to wrong users

**Solution:** Use private cache or no-cache for personalized content

```
âŒ Bad:
/user/profile â†’ Cached â†’ User B sees User A's profile

âœ… Good:
Cache-Control: private, no-cache
â†’ Not cached, always fetched from origin
```

---

## Trade-offs Summary

| Aspect          | What You Gain                        | What You Sacrifice                                |
|-----------------|--------------------------------------|---------------------------------------------------|
| **CDN Caching** | Low latency, reduced bandwidth       | Stale content risk, cache invalidation complexity |
| **Long TTL**    | High cache hit rate, low origin load | Stale content, slow updates                       |
| **Short TTL**   | Fresh content, fast updates          | Lower cache hit rate, higher origin load          |
| **Push CDN**    | Guaranteed cache hit, predictable    | Storage cost, upload complexity                   |
| **Pull CDN**    | Simple, cost-effective               | First request slower, origin must handle misses   |

---

## References

- **AWS CloudFront Documentation:** [https://docs.aws.amazon.com/cloudfront/](https://docs.aws.amazon.com/cloudfront/)
- **Cloudflare CDN:** [https://www.cloudflare.com/cdn/](https://www.cloudflare.com/cdn/)
- **Related Chapters:**
    - [2.2.1 Caching Deep Dive](./2.2.1-caching-deep-dive.md) - Caching strategies
    - [1.2.2 Networking Components](../../01-principles/1.2.2-networking-components.md) - CDN overview

---

## âœï¸ Design Challenge

### Problem

You are designing a video streaming platform (similar to YouTube) that serves 1 billion videos to 100 million daily
active users globally. The platform must:

1. **Serve videos** with <2 second startup latency
2. **Handle traffic spikes** (10Ã— normal traffic during viral videos)
3. **Minimize bandwidth costs** (bandwidth is 80% of infrastructure cost)
4. **Support multiple video qualities** (240p, 360p, 480p, 720p, 1080p, 4K)
5. **Handle global audience** (users in 200+ countries)

**Constraints:**

- Origin server bandwidth: $0.09/GB
- CDN bandwidth: $0.01/GB (10Ã— cheaper)
- Average video size: 500 MB (1080p)
- Cache hit rate target: 95%+
- Storage cost: $0.023/GB/month

Design a CDN strategy that:

- Minimizes bandwidth costs
- Meets latency requirements (<2s startup)
- Handles traffic spikes
- Supports multiple video qualities
- Serves global audience

### Solution

#### ðŸ§© Scenario

- **Users:** 100 million daily active users
- **Videos:** 1 billion videos
- **Traffic:** Global (200+ countries)
- **Latency Target:** <2 seconds startup
- **Cost Optimization:** Bandwidth is 80% of cost

**Calculations:**

- **Daily Views:** 100M users Ã— 5 videos/day = 500M views/day
- **Daily Bandwidth:** 500M views Ã— 500 MB = 250 PB/day
- **Cost Without CDN:** 250 PB Ã— $0.09/GB = $22.5M/day
- **Cost With CDN (95% hit):** 12.5 PB Ã— $0.09/GB + 237.5 PB Ã— $0.01/GB = $3.4M/day
- **Savings:** $19.1M/day (85% reduction)

#### âœ… Step 1: CDN Architecture

**Choice: Multi-Tier CDN with Regional Caching**

**Architecture:**

```
Tier 1: Origin Servers (S3)
  â””â”€ Source of truth for all videos

Tier 2: Regional CDN Hubs (10 regions)
  â””â”€ Cache popular videos per region
  â””â”€ Locations: US-East, US-West, EU, Asia-Pacific, etc.

Tier 3: Edge Locations (200+ locations)
  â””â”€ Cache very popular videos
  â””â”€ Serve users from nearest edge
```

**Why Multi-Tier:**

- **Regional Hubs:** Cache regionally popular content (reduces origin load)
- **Edge Locations:** Serve users from nearest location (lowest latency)
- **Cost Optimization:** Popular content at edge, less popular at regional hubs

#### âœ… Step 2: Caching Strategy

**A. Popular Videos (Top 10%):**

```
Cache Location: All edge locations
TTL: 30 days (videos rarely change)
Cache Hit Rate: 98%+
```

**B. Moderately Popular Videos (Next 20%):**

```
Cache Location: Regional hubs only
TTL: 7 days
Cache Hit Rate: 85%+
```

**C. Long-Tail Videos (Remaining 70%):**

```
Cache Location: Origin only (not cached)
TTL: N/A
Cache Hit Rate: 0% (always fetched from origin)
```

**Result:**

- **Overall Cache Hit Rate:** 95%+ (weighted average)
- **Bandwidth Savings:** 95% of traffic served from CDN

#### âœ… Step 3: Video Quality Caching

**Problem:** Multiple qualities (240p, 360p, 480p, 720p, 1080p, 4K) â†’ 6Ã— storage

**Solution: Tiered Quality Caching**

**Strategy:**

```
Popular Videos:
  - Cache all qualities at edge (high demand)
  - Storage: 6Ã— video size
  - Benefit: Instant quality switching

Moderately Popular Videos:
  - Cache 3 qualities (360p, 720p, 1080p) at regional hubs
  - Other qualities: On-demand transcoding
  - Storage: 3Ã— video size

Long-Tail Videos:
  - No caching (always fetched from origin)
  - On-demand transcoding for all qualities
  - Storage: 0 (origin only)
```

**Storage Calculation:**

```
Popular (10%): 100M videos Ã— 500 MB Ã— 6 qualities = 300 PB
Moderate (20%): 200M videos Ã— 500 MB Ã— 3 qualities = 300 PB
Long-Tail (70%): 700M videos Ã— 500 MB Ã— 0 = 0 PB (origin only)
Total CDN Storage: 600 PB
Cost: 600 PB Ã— $0.023/GB/month = $13.8M/month
```

#### âœ… Step 4: Cache Invalidation Strategy

**A. Video Updates:**

```
1. Video metadata updated (title, description)
   â†’ Invalidate metadata cache (fast, <1 minute)

2. Video content updated (re-upload)
   â†’ Invalidate all quality caches
   â†’ Pre-warm popular qualities to edge
```

**B. Viral Video Handling:**

```
1. Video goes viral (sudden popularity spike)
2. CDN detects high request rate
3. CDN automatically promotes to edge cache
4. Pre-warms all qualities to all edge locations
5. Result: Handles 10Ã— traffic spike
```

#### âœ… Step 5: Geographic Distribution

**Edge Location Strategy:**

```
High-Traffic Regions (US, EU, Asia):
  - Multiple edge locations per country
  - Cache popular content at all edges
  - Low latency (<20ms)

Medium-Traffic Regions (South America, Africa):
  - Regional hub per continent
  - Cache moderately popular content
  - Acceptable latency (<50ms)

Low-Traffic Regions:
  - Nearest regional hub
  - No edge caching (fetch from hub)
  - Higher latency (<100ms, acceptable)
```

#### âœ… Step 6: Adaptive Bitrate Streaming

**How It Works:**

```
1. User starts video â†’ CDN serves manifest file (HLS/DASH)
2. Manifest lists available qualities and URLs
3. Player selects quality based on bandwidth
4. CDN serves segments from cached quality
5. Player switches quality seamlessly (adaptive)
```

**CDN Caching:**

```
Manifest File:
  - Cache at edge (TTL: 5 minutes)
  - Updates when video metadata changes

Video Segments:
  - Cache per quality at edge
  - TTL: 30 days (videos rarely change)
  - High cache hit rate (95%+)
```

#### âœ… Step 7: Cost Optimization

**Bandwidth Cost Breakdown:**

```
Without CDN:
  250 PB/day Ã— $0.09/GB = $22.5M/day

With CDN (95% hit rate):
  Origin bandwidth: 12.5 PB/day Ã— $0.09/GB = $1.125M/day
  CDN bandwidth: 237.5 PB/day Ã— $0.01/GB = $2.375M/day
  Total: $3.5M/day

Savings: $19M/day (85% reduction)
```

**Storage Cost:**

```
CDN Storage: 600 PB Ã— $0.023/GB/month = $13.8M/month
Origin Storage: 350 PB Ã— $0.023/GB/month = $8.05M/month
Total Storage: $21.85M/month
```

**Total Cost:**

```
Bandwidth: $3.5M/day Ã— 30 = $105M/month
Storage: $21.85M/month
Total: $126.85M/month

vs. Without CDN: $675M/month (bandwidth only)
Savings: $548M/month (81% reduction)
```

#### âœ… Complete Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Global Users (200+ countries)               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚              â”‚              â”‚
        â–¼              â–¼              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Edge (Tokyo) â”‚ â”‚ Edge (NY)â”‚ â”‚ Edge (London)â”‚
â”‚ (200+ edges) â”‚ â”‚          â”‚ â”‚              â”‚
â”‚              â”‚ â”‚          â”‚ â”‚              â”‚
â”‚ Cache:       â”‚ â”‚ Cache:   â”‚ â”‚ Cache:       â”‚
â”‚ - Top 10%    â”‚ â”‚ - Top 10%â”‚ â”‚ - Top 10%    â”‚
â”‚ - All quals  â”‚ â”‚ - All qlsâ”‚ â”‚ - All qls    â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚               â”‚              â”‚
       â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚              â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚      Regional Hubs (10 regions)    â”‚
    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
    â”‚  â”‚ Cache: Next 20% videos        â”‚ â”‚
    â”‚  â”‚ Qualities: 3 (360p, 720p, 1080p)â”‚ â”‚
    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚      Origin Servers (S3)            â”‚
    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
    â”‚  â”‚ All videos (1B)               â”‚  â”‚
    â”‚  â”‚ All qualities (on-demand)     â”‚  â”‚
    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Request Flow:**

```
1. User (Tokyo) requests video
2. DNS â†’ Routes to Tokyo edge
3. Edge checks cache â†’ Hit (popular video)
4. Edge serves video (all qualities cached)
5. Latency: <20ms (cache hit)

If cache miss:
1. Edge â†’ Regional hub (Asia-Pacific)
2. Hub checks cache â†’ Hit (moderately popular)
3. Hub serves video (3 qualities)
4. Latency: <50ms

If hub miss:
1. Hub â†’ Origin (S3)
2. Origin serves video (on-demand transcoding)
3. Hub caches video
4. Latency: <200ms (first request)
```

#### âš–ï¸ Trade-offs Summary

| Decision                   | What We Gain                   | What We Sacrifice                   |
|----------------------------|--------------------------------|-------------------------------------|
| **Multi-Tier CDN**         | Cost optimization, low latency | Complexity, cache management        |
| **Tiered Quality Caching** | Storage cost reduction         | Some quality switching latency      |
| **95% Cache Hit Rate**     | 85% bandwidth cost reduction   | 5% requests hit origin (acceptable) |
| **Regional Hubs**          | Balance cost and latency       | Slightly higher latency than edge   |
| **Long-Tail No Cache**     | Storage cost savings           | Higher latency for unpopular videos |

#### âœ… Final Summary

**CDN Strategy:**

- **Architecture:** Multi-tier (Origin â†’ Regional Hubs â†’ Edge Locations)
- **Caching:** Tiered by popularity (Top 10% at edge, Next 20% at hubs, 70% origin only)
- **Quality Caching:** All qualities for popular, 3 qualities for moderate
- **Cache Hit Rate:** 95%+ (weighted average)
- **Geographic:** 200+ edge locations, 10 regional hubs

**Performance:**

- **Startup Latency:** <2 seconds (95% cache hit, <20ms edge latency)
- **Bandwidth Cost:** $3.5M/day (vs $22.5M/day without CDN, 85% savings)
- **Storage Cost:** $21.85M/month (600 PB CDN + 350 PB origin)

**Result:**

- âœ… <2 second startup latency (95% cache hit)
- âœ… Handles 10Ã— traffic spikes (automatic promotion to edge)
- âœ… 85% bandwidth cost reduction
- âœ… Supports multiple qualities (adaptive bitrate)
- âœ… Serves global audience (200+ edge locations)

